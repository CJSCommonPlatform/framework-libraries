<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JaxRsResourceInterfaceCodeGenerator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">raml-jaxrs-core</a> &gt; <a href="index.source.html" class="el_package">uk.gov.justice.raml.jaxrs.core</a> &gt; <span class="el_source">JaxRsResourceInterfaceCodeGenerator.java</span></div><h1>JaxRsResourceInterfaceCodeGenerator.java</h1><pre class="source lang-java linenums">package uk.gov.justice.raml.jaxrs.core;

import static java.util.Collections.unmodifiableList;
import static org.apache.commons.lang.StringUtils.defaultIfBlank;
import static org.apache.commons.lang.StringUtils.isNotBlank;
import static org.apache.commons.lang.StringUtils.strip;
import static uk.gov.justice.raml.jaxrs.core.Names.GENERIC_PAYLOAD_ARGUMENT_NAME;

import java.lang.annotation.Annotation;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import javax.json.JsonObject;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;

import org.apache.commons.lang.StringUtils;
import org.raml.model.Action;
import org.raml.model.MimeType;
import org.raml.model.Resource;
import org.raml.model.parameter.UriParameter;

import com.sun.codemodel.JAnnotatable;
import com.sun.codemodel.JClass;
import com.sun.codemodel.JClassAlreadyExistsException;
import com.sun.codemodel.JCodeModel;
import com.sun.codemodel.JDefinedClass;
import com.sun.codemodel.JMethod;
import com.sun.codemodel.JMod;
import com.sun.codemodel.JPackage;
import com.sun.codemodel.JVar;

public class JaxRsResourceInterfaceCodeGenerator {
<span class="fc" id="L42">    private static final List&lt;Class&lt;? extends Annotation&gt;&gt; JAXRS_HTTP_METHODS = unmodifiableList(Arrays.asList(</span>
            GET.class, POST.class));
    private static final String DEFAULT_ANNOTATION_PARAMETER = &quot;value&quot;;
    private final JCodeModel codeModel;
    private final Configuration configuration;
    private final Map&lt;String, Set&lt;String&gt;&gt; resourcesMethods;
    private final Map&lt;String, Object&gt; httpMethodAnnotations;

    public JaxRsResourceInterfaceCodeGenerator(JCodeModel codeModel, Configuration configuration) {
<span class="fc" id="L51">        super();</span>
<span class="fc" id="L52">        this.codeModel = codeModel;</span>
<span class="fc" id="L53">        this.configuration = configuration;</span>
<span class="fc" id="L54">        this.resourcesMethods = new HashMap&lt;String, Set&lt;String&gt;&gt;();</span>
<span class="fc" id="L55">        this.httpMethodAnnotations = new HashMap&lt;String, Object&gt;();</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        for (final Class&lt;? extends Annotation&gt; clazz : JAXRS_HTTP_METHODS) {</span>
<span class="fc" id="L57">            httpMethodAnnotations.put(clazz.getSimpleName(), clazz);</span>
<span class="fc" id="L58">        }</span>
<span class="fc" id="L59">    }</span>

    public JDefinedClass createInterface(final Resource ramlResourceDef)
            throws JClassAlreadyExistsException {

<span class="fc" id="L64">        String interfaceName = Names.resourceInterfaceNameOf(ramlResourceDef, configuration);</span>
<span class="fc" id="L65">        final JDefinedClass resourceInterface = interfaceClassOf(interfaceName);</span>
<span class="fc" id="L66">        final String path = strip(ramlResourceDef.getRelativeUri(), &quot;/&quot;);</span>
<span class="fc" id="L67">        resourceInterface.annotate(Path.class).param(DEFAULT_ANNOTATION_PARAMETER, defaultIfBlank(path, &quot;/&quot;));</span>
<span class="fc" id="L68">        addResourceMethods(ramlResourceDef, resourceInterface, path);</span>
<span class="fc" id="L69">        return resourceInterface;</span>

    }

    private JDefinedClass interfaceClassOf(final String name) throws JClassAlreadyExistsException {
        String actualName;
<span class="fc" id="L75">        int i = -1;</span>
        while (true) {
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            actualName = name + (++i == 0 ? &quot;&quot; : Integer.toString(i));</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            if (!resourcesMethods.containsKey(actualName)) {</span>
<span class="fc" id="L79">                resourcesMethods.put(actualName, new HashSet&lt;String&gt;());</span>
<span class="fc" id="L80">                break;</span>
            }
        }

<span class="fc" id="L84">        final JPackage pkg = codeModel</span>
<span class="fc" id="L85">                ._package(configuration.getBasePackageName() + &quot;.&quot; + configuration.getRestIFPackageName());</span>
<span class="fc" id="L86">        return pkg._interface(actualName);</span>
    }

    private void addResourceMethods(final Resource resource,
            final JDefinedClass resourceInterface,
            final String resourceInterfacePath) {

<span class="fc bfc" id="L93" title="All 2 branches covered.">        for (final Action action : resource.getActions().values()) {</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (!action.hasBody()) {</span>
<span class="nc" id="L95">                addResourceMethod(resourceInterface, resourceInterfacePath, action, null, false);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            } else if (action.getBody().size() == 1) {</span>
<span class="fc" id="L97">                final MimeType bodyMimeType = action.getBody().values().iterator().next();</span>
<span class="fc" id="L98">                addResourceMethod(resourceInterface, resourceInterfacePath, action, bodyMimeType, false);</span>
<span class="fc" id="L99">            } else {</span>
<span class="fc" id="L100">                action.getBody().values().stream().sorted((t1, t2) -&gt; t1.getType().compareTo(t2.getType()))</span>
<span class="fc" id="L101">                        .forEach(bodyMimeType -&gt; addResourceMethod(resourceInterface, resourceInterfacePath,</span>
                                action, bodyMimeType, true));
            }
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">    }</span>

    private JMethod addResourceMethod(final JDefinedClass resourceInterface,
            final String resourceInterfacePath,
            final Action action,
            final MimeType bodyMimeType,
            final boolean addBodyMimeTypeInMethodName) {

<span class="fc bfc" id="L113" title="All 2 branches covered.">        MimeType actualBodyMimeType = addBodyMimeTypeInMethodName ? bodyMimeType : null;</span>
<span class="fc" id="L114">        String methodName = null;</span>

<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (methodName == null) {</span>
<span class="fc" id="L117">            methodName = Names.buildResourceMethodName(action, actualBodyMimeType);</span>
        }

<span class="fc" id="L120">        final JClass resourceMethodReturnType = codeModel.ref(&quot;javax.ws.rs.core.Response&quot;);</span>

<span class="fc" id="L122">        final JMethod method = createResourceMethod(resourceInterface, methodName,</span>
                resourceMethodReturnType);
<span class="fc" id="L124">        addHttpMethodAnnotation(action.getType().toString(), method);</span>

<span class="fc" id="L126">        addParamAnnotation(resourceInterfacePath, action, method);</span>
<span class="fc" id="L127">        addConsumesAnnotation(bodyMimeType, method);</span>

<span class="fc" id="L129">        addPathParameters(action, method);</span>
<span class="fc" id="L130">        addBodyParameters(bodyMimeType, method);</span>
<span class="fc" id="L131">        return method;</span>
    }

    private void addParamAnnotation(final String resourceInterfacePath,
            final Action action, final JMethod method) {
<span class="fc" id="L136">        final String path = StringUtils.substringAfter(action.getResource()</span>
<span class="fc" id="L137">                .getUri(), resourceInterfacePath + &quot;/&quot;);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (isNotBlank(path)) {</span>
<span class="nc" id="L139">            method.annotate(Path.class).param(DEFAULT_ANNOTATION_PARAMETER,</span>
                    path);
        }
<span class="fc" id="L142">    }</span>

    private void addConsumesAnnotation(final MimeType bodyMimeType,
            final JMethod method) {
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (bodyMimeType != null) {</span>
<span class="fc" id="L147">            method.annotate(Consumes.class).param(DEFAULT_ANNOTATION_PARAMETER,</span>
<span class="fc" id="L148">                    bodyMimeType.getType());</span>
        }
<span class="fc" id="L150">    }</span>

    private void addPathParameters(final Action action, final JMethod method) {
<span class="fc" id="L153">        addAllResourcePathParameters(action.getResource(), method);</span>
<span class="fc" id="L154">    }</span>

    private void addAllResourcePathParameters(Resource resource,
            final JMethod method) {

<span class="fc bfc" id="L159" title="All 2 branches covered.">        for (final Entry&lt;String, UriParameter&gt; namedUriParameter : resource</span>
<span class="fc" id="L160">                .getUriParameters().entrySet()) {</span>
<span class="fc" id="L161">            addParameter(namedUriParameter.getKey(), PathParam.class, method);</span>
<span class="fc" id="L162">        }</span>

<span class="fc" id="L164">        Resource parentResource = resource.getParentResource();</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (parentResource != null) {</span>
<span class="nc" id="L167">            addAllResourcePathParameters(parentResource, method);</span>
        }

<span class="fc" id="L170">    }</span>

    private void addParameter(final String name,
            final Class&lt;? extends Annotation&gt; annotationClass,
            final JMethod method) {

<span class="fc" id="L176">        final String argumentName = Names.buildVariableName(name);</span>

<span class="fc" id="L178">        final JVar argumentVariable = method</span>
<span class="fc" id="L179">                .param(codeModel.ref(&quot;String&quot;), argumentName);</span>

<span class="fc" id="L181">        argumentVariable.annotate(annotationClass).param(</span>
                DEFAULT_ANNOTATION_PARAMETER, name);

<span class="fc" id="L184">    }</span>

    private void addBodyParameters(final MimeType bodyMimeType,
            final JMethod method) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (bodyMimeType == null) {</span>
<span class="nc" id="L189">            return;</span>
        } else {
<span class="fc" id="L191">            method.param(JsonObject.class, GENERIC_PAYLOAD_ARGUMENT_NAME);</span>
        }
<span class="fc" id="L193">    }</span>

    private JMethod createResourceMethod(final JDefinedClass resourceClass,
            final String methodName,
            final JClass returnType) {
<span class="fc" id="L198">        final Set&lt;String&gt; existingMethodNames = resourcesMethods.get(resourceClass.name());</span>

        String actualMethodName;
<span class="fc" id="L201">        int i = -1;</span>
        while (true) {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            actualMethodName = methodName + (++i == 0 ? &quot;&quot; : Integer.toString(i));</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">            if (!existingMethodNames.contains(actualMethodName)) {</span>
<span class="fc" id="L205">                existingMethodNames.add(actualMethodName);</span>
<span class="fc" id="L206">                break;</span>
            }
        }

<span class="fc" id="L210">        return resourceClass.method(JMod.NONE, returnType, actualMethodName);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private void addHttpMethodAnnotation(final String httpMethod, final JAnnotatable annotatable) {
<span class="fc" id="L215">        final Object annotationClass = httpMethodAnnotations.get(httpMethod.toUpperCase());</span>
<span class="fc" id="L216">        annotatable.annotate((Class&lt;? extends Annotation&gt;) annotationClass);</span>
<span class="fc" id="L217">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>